# Based on: https://github.com/google/ml-metadata/blob/v1.14.0/ml_metadata/tools/docker_server/Dockerfile
name: ml-metadata
summary: Part of the ML Metadata (MLMD) framework.
description: |
  ML Metadata is a framework for managing and tracking metadata associated with ML workflows. 
  It is part of the TensorFlow Extended (TFX) ecosystem, but it can be used independently as well.
version: "1.14.0"
license: Apache-2.0
# Note: Previous builds failed on ubuntu@22.04 (see https://github.com/google/ml-metadata/issues/210).
# This rock is based on ubuntu@24.04, which has been validated to build successfully.
base: ubuntu@24.04
run-user: _daemon_
platforms:
  amd64:

services:
  mlmd:
    override: replace
    summary: "ml metadata store service"
    startup: enabled
    environment:
      GRPC_PORT: "8080"
      METADATA_STORE_SERVER_CONFIG_FILE: ""
    command: "/bin/metadata_store_server --grpc_port=${GRPC_PORT} --metadata_store_server_config_file=${METADATA_STORE_SERVER_CONFIG_FILE}"

parts:
  security-team-requirement:
    plugin: nil
    override-build: |
      mkdir -p ${CRAFT_PART_INSTALL}/usr/share/rocks
      (echo "# os-release" && cat /etc/os-release && echo "# dpkg-query" && \
       dpkg-query -f '${db:Status-Abbrev},${binary:Package},${Version},${source:Package},${Source:Version}\n' -W) > \
       ${CRAFT_PART_INSTALL}/usr/share/rocks/dpkg.query

  mlmd:
    plugin: nil
    source: https://github.com/google/ml-metadata.git
    source-tag: v1.14.0
    build-packages:
      - build-essential
      - clang
      - cmake
      - make
      - musl-dev
      - ca-certificates
      - openssl
      - curl
      - unzip
      - software-properties-common
      - git
      - python-is-python3
      - python3-dev
    stage-packages:
      - tzdata
    build-environment:
      - BAZEL_VERSION: 5.3.0
    override-build: |
      set -xe
      
      curl -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36" -fSsL -O https://github.com/bazelbuild/bazel/releases/download/${BAZEL_VERSION}/bazel-${BAZEL_VERSION}-installer-linux-x86_64.sh
      
      curl -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36" -fSsL -o /LICENSE.txt https://raw.githubusercontent.com/bazelbuild/bazel/master/LICENSE
      
      chmod +x bazel-*.sh

      ./bazel-${BAZEL_VERSION}-installer-linux-x86_64.sh
      
      cd $CRAFT_PART_SRC

      # Fix ZetaSQL checksum and prefix issues
      # The WORKSPACE file in ml-metadata v1.14.0 has two issues:
      # 1. Outdated ZetaSQL checksum that doesn't match the actual archive
      # 2. The archive prefix changed from "zetasql-" to "googlesql-" (repository was renamed)
      # Replace the old checksum with the actual checksum
      sed -i "s/sha256 = '651a768cd51627f58aa6de7039aba9ddab22f4b0450521169800555269447840'/sha256 = '86f81591ab5ec20457a5394eb2c5c981e6f6c89f4c49c211d096c3acffec1eb1'/" WORKSPACE
      # Fix the strip_prefix to use "googlesql-" instead of "zetasql-"
      sed -i 's/strip_prefix = "zetasql-%s"/strip_prefix = "googlesql-%s"/' WORKSPACE

      bazel clean --expunge
      
      bazel build -c opt --action_env=PATH --define=grpc_no_ares=true //ml_metadata/metadata_store:metadata_store_server --cxxopt="-std=c++17"

      mkdir -p $CRAFT_PART_INSTALL/bin
      mkdir -p $CRAFT_PART_INSTALL/third_party

      cp -RL $CRAFT_PART_SRC/bazel-src/external/libmysqlclient $CRAFT_PART_INSTALL/third_party/mariadb-connector-c

      cp $CRAFT_PART_SRC/bazel-bin/ml_metadata/metadata_store/metadata_store_server $CRAFT_PART_INSTALL/bin/metadata_store_server
