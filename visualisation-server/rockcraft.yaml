# Dockerfile: https://github.com/kubeflow/pipelines/blob/2.0.0/backend/Dockerfile.visualization
name: ml-pipeline-visualization-server
base: ubuntu:20.04
version: '2.0.0_20.04_1'
summary: ml-pipeline/visualization-server
description: |
    ml-pipeline/visualization-server
    https://github.com/kubeflow/pipelines/tree/master/backend
license: GPL-3.0
platforms:
    amd64:
run-user: _daemon_
services:
  vis-server:
    override: replace
    command: python3 /server.py
    startup: enabled

package-repositories:
  - type: apt
    ppa: deadsnakes/ppa
    priority: always

parts:
  patch:
    plugin: nil
    source: .
    override-build: |
      cp backend/src/apiserver/visualization/requirements.in ${CRAFT_PART_INSTALL}/

  python:
    after: [patch]
    plugin: python
    source: https://github.com/kubeflow/pipelines.git
    source-tag: 2.0.0
    stage-packages:
    - pip
    - python3.8-venv
    override-build: |
      # install tensorflow*
      python3.8 -m pip install pip install tensorflow==2.11.1 tensorflow-metadata tensorflow-model-analysis tensorflow-data-validation tensorflow-serving-api

      # copy requirements.in from patch part
      cp /root/parts/patch/install/requirements.in backend/src/apiserver/visualization/requirements.in

      python3.8 -m pip install pip==22.0.4 setuptools --upgrade --quiet
      python3.8 -m pip install pip-tools==5.4.0 --quiet
      export PATH=$PATH:${CRAFT_PART_INSTALL}/usr/local/bin
      pip-compile --verbose backend/src/apiserver/visualization/requirements.in
      python3.8 -m pip install cython
      python3.8 -m pip install -r backend/src/apiserver/visualization/requirements.txt --no-cache-dir

      cp -r backend/src/apiserver/visualization/* ${CRAFT_PART_INSTALL}

  gcloud:
    plugin: nil
    stage-packages:
    - wget
    - curl
    - tar
    - openssl
    override-build: |
      set -x
      curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
      mkdir -p "${CRAFT_PART_INSTALL}"/usr/local/gcloud
      tar -C "${CRAFT_PART_INSTALL}"/usr/local/gcloud -xf /tmp/google-cloud-sdk.tar.gz
      "${CRAFT_PART_INSTALL}"/usr/local/gcloud/google-cloud-sdk/install.sh
      cp backend/src/apiserver/visualization/server.py $CRAFT_PART_INSTALL
